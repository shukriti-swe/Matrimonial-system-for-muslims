<!-- croppie js -->
<script src="<?=base_url()?>template/front/js/croppie.js"></script>
<!-- Paypal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AVwBm6KbivE7_cCPyVzN5nFnfR9VSK8ZkBSQTcrr0QdlTEHpIMgtrOI-J8gu9cXe8E3TZCk9ghJewori&vault=true" data-sdk-integration-source="button-factory"></script>

<!-- SCRIPTS -->
<!-- Core -->
<script src="<?=base_url()?>template/front/vendor/popper/popper.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="<?=base_url()?>template/front/js/vendor/jquery.easing.js"></script>
<script src="<?=base_url()?>template/front/js/ie10-viewport-bug-workaround.js"></script>
<script src="<?=base_url()?>template/front/js/slidebar/slidebar.js"></script>
<script src="<?=base_url()?>template/front/js/classie.js"></script>
<!-- Bootstrap Extensions -->
<script src="<?=base_url()?>template/front/vendor/bootstrap-dropdown-hover/js/bootstrap-dropdown-hover.js"></script>
<script src="<?=base_url()?>template/front/vendor/bootstrap-notify/bootstrap-growl.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/scrollpos-styler/scrollpos-styler.js"></script>
<!-- Plugins -->
<script src="<?=base_url()?>template/front/vendor/flatpickr/flatpickr.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/easy-pie-chart/jquery.easypiechart.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/footer-reveal/footer-reveal.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/sticky-kit/sticky-kit.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/swiper/js/swiper.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/paraxify/paraxify.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/viewport-checker/viewportchecker.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/milestone-counter/jquery.countTo.js"></script>
<script src="<?=base_url()?>template/front/vendor/countdown/js/jquery.countdown.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/typed/typed.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/instafeed/instafeed.js"></script>
<script src="<?=base_url()?>template/front/vendor/gradientify/jquery.gradientify.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/nouislider/js/nouislider.min.js"></script>
<!-- Isotope -->
<script src="<?=base_url()?>template/front/vendor/isotope/isotope.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
<!-- Light Gallery -->
<script src="<?=base_url()?>template/front/vendor/lightgallery/js/lightgallery.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
<script src="<?=base_url()?>template/front/vendor/lightgallery/js/lg-video.js"></script>
<!-- App JS -->
<script src="<?=base_url()?>template/front/js/wpx.app.js"></script>
<!--DataTables [ OPTIONAL ]-->
<script src="<?=base_url()?>template/back/plugins/datatables/media/js/jquery.dataTables.js"></script>
<script src="<?=base_url()?>template/back/plugins/datatables/extensions/Responsive/js/dataTables.responsive.min.js"></script>

<!-- ======================================================== -->

<!-- jquery -->
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/vendors/vendors.js") ?>"></script>
<!-- Local Revolution tools-->
<!-- Only for local and can be removed on server-->

<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/custom.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/jquery-dateFormat.min.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/jquery.playSound.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/toastr.min.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/anchorme.min.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/fastselect.standalone.min.js") ?>"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magicsuggest/2.1.5/magicsuggest-min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<!-- <script src="<?php /*echo base_url("template/front/assets/newTheme/assets/js/socket.io.min.js")."?".rand(5,50000); */?>"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/socket.io-file-client.js") ?>"></script>

<script src="<?php echo base_url("template/front/assets/js/scripts/jwt-decode.min.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/js/bootstrap-timepicker.min.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/js/jquery-ui.min.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/js/bootstrap-multiselect.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/clamp.min.js") ?>"></script>

<script src="//vjs.zencdn.net/5.4.6/video.min.js"></script>
<script>
    var baseUrl="<?php echo base_url() ?>";
</script>

<script src="<?php echo base_url("template/front/assets/js/video.min.js")?>"></script>
<script src="<?php echo base_url("template/front/assets/js/scripts/fullcalendar.min.js") ?>"></script>

<!-- ------------------------------------------ -->

<script type="text/javascript" src="<?php echo base_url("template/front/assets/newTheme/assets/js/loadingoverlay.js") ?>"></script>
<script type="text/javascript" src="<?php echo base_url("template/front/assets/newTheme/assets/js/loadingoverlay_progress.js") ?>"></script>
<script src="<?php echo base_url("template/front/assets/newTheme/assets/js/si.js")."?".rand(5,50000); ?>"></script>
<script type="text/javascript" src="<?php echo base_url("template/front/assets/newTheme/assets/js/twemoji-picker.js") ?>"></script>
<!--<script type="text/javascript" src="<?php /*echo base_url("assets/newTheme/assets/js/perfect-scrollbar.jquery.js")."?".rand(5,50000) */?>"></script>-->
<!--<script type="text/javascript" src="<?php /*echo base_url("assets/newTheme/assets/js/perfect-scrollbar.jquery.min.js") */?>"></script>-->

<script type="text/javascript" src="<?php echo base_url("template/front/assets/js/perfect-scrollbar.jquery.min.js") ?>"></script>

<script src="//twemoji.maxcdn.com/2/twemoji.min.js?2.2.3"></script>


<script type="text/javascript">

    toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": false,
        "progressBar": false,
        "positionClass": "toast-bottom-left",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    };

    

    $(document).ready(function () {

        $("body").css("overflow","hidden", "important");
        moment.locale('de');
        /*
            window and element resizing besed on user window size
        */

        $(window).bind("resize",function () {
            let viewHeight=$(window).height();
            let viewWidth=$(window).width();
            if(viewWidth<990){
                $('#convStart').css("height",75);
                $('.persons').css({"margin-top":0});
                $(".rightSection").css({'margin-top': '0px'});
                // $(".groupNameDiv").css({"padding-bottom":'0px'});
                $('.video').css({'margin-left': '-34px'});

            }
            else {
                $(".rightSection").css({'margin-top': '0px'});
                // $(".groupNameDiv").css({"margin-top":'0px'});
                $('.video').css({'margin-left': '0px'})
            }
            /*if(viewHeight<776){
             $("#newMModalBody").css("margin-bottom", "155px");
             }else {
             $("#newMModalBody").css("margin-bottom", "160px");
             }*/
            if(viewWidth<990){
                $(".leftSection").css({"height":(viewHeight-95)});
                $(".middleSection").css({"height":(viewHeight-95)});
                $(".rightSection").css({"height":(viewHeight-95)});
            }
            else{
                $(".leftSection").css({"height":628});
                $(".middleSection").css({"min-height":628});
                $(".rightSection").css({"height":628});
            }
            $(".chat").css({"height":(viewHeight-20)});
            $('.persons').css({"height":(viewHeight-60)});
            $('.personsList').css({"height":(viewHeight-50)});
        }).trigger("resize");

        /*
           --------Global variables
         */
        let chatBox=$('#chatBox');
        let groupBox=$("#groups");
        let videoObjects=[];
        let responce=localStorage.getItem("_r");
        console.log(responce);
        let type=jwt_decode(responce).userType;
        //let type=1;

        let start=0;
        let limit=30;
        let groupLimit=30;
        let groupStart=0;
        let totalGroup=null;
        let friendStart=0;
        let friendLimit=30;
        let totalFriend=null;
        let totalRetivedMessage=0;
        let userId=jwt_decode(responce).userId;
        // let userId=responce;
        let groupIds=[];
        let time=[];
        let groupImages={};

        let scrollPosition=null;
        let notRequested=true;

        let typing = false;
        let typingTimeout = undefined;
        let lastMessageDate=null;
        let topMessage=null;
        let addexpendDropdown=null;
        let addMemberexpendDropdown=null;

        let magicSuggestOption={
            placeholder: 'Search for members...',
            maxSelection:null,
            allowFreeEntries:false,
            // data: q,
            renderer: function(data){
                return '<div style="padding: 5px; overflow:hidden;">' +
                    '<div style="float: left;"><img style="width: 25px;height: 25px" src="' + data.picture + '" /></div>' +
                    '<div style="float: left; margin-left: 5px">' +
                    '<div style="font-weight: bold; color: #333; font-size: 12px; line-height: 11px">' + data.name + '</div>' +
                    '<div style="color: #999; font-size: 9px">' + data.email + '</div>' +
                    '</div>' +
                    '</div><div style="clear:both;"></div>'; // make sure we have closed our dom stuff
            }
        };
        let addmember=$('#addMemberInput').magicSuggest(magicSuggestOption);
        let newMemberInput=$('#addNewMemberInput').magicSuggest(magicSuggestOption);
        /*let momentOptions={
            sameDay: '[Today at] h:mm a',
            nextDay: '[Tomorrow at] at h:mm a',
            nextWeek: 'dddd [at] h:mm a',
            lastDay: '[Yesterday at] h:mm a',
            lastWeek: '[Last] dddd [at] h:mm a',
            sameElse: 'MMM DD, YYYY h:mm a'
        };*/
        let momentOptions={
            sameDay: '[Today at] h:mm a',
            nextDay: '[Tomorrow at] at h:mm a',
            nextWeek: 'dddd [at] h:mm a',
            lastDay: 'MMMM DD, YYYY h:mm a',
            lastWeek: 'MMMM DD, YYYY h:mm a',
            sameElse: 'MMMM DD, YYYY h:mm a'
        };
        // let momentOptions2={
        //     sameDay: 'h:mm a',
        //     nextDay: '[Tomorrow at] at h:mm a',
        //     nextWeek: 'dddd [at] h:mm a',
        //     lastDay: '[Yesterday at] h:mm a',
        //     lastWeek: '[Last] dddd [at] h:mm a',
        //     sameElse: 'MMM DD, YYYY h:mm a'
        // };

        let momentOptions2={
            sameDay: 'h:mm a',
            nextDay: '[Tomorrow at]',
            nextWeek: 'dddd',
            lastDay: '[Yesterday at]',
            lastWeek: '[Last] dddd ',
            sameElse: 'MMM DD, YYYY'
        };

        // new add
        let momentOptions3={
            sameDay: 'h:mm a',
            nextDay: 'h:mm a',
            nextWeek: 'h:mm a',
            lastDay: 'h:mm a',
            lastWeek: 'h:mm a',
            sameElse: 'h:mm a'
        };
        // --------- Global Functions--------------




        function typingTimeoutFunction(){
            let groupId=$("#addMember").attr('data-group');
            let data={
                _r:token,
                groupId:groupId
            };
            typing = false;
            socket.emit("notTyping",JSON.stringify(data));
        }
        function onKeyDownNotEnter(){
            let groupId=$("#addMember").attr('data-group');
            let data={
                _r:token,
                groupId:groupId
            };
            if(typing == false) {
                typing = true;
                socket.emit("typing",JSON.stringify(data));
                typingTimeout = setTimeout(typingTimeoutFunction, 3000);
            } else {
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(typingTimeoutFunction, 3000);
            }

        }
        // this function used to clear new message div
        function resetNewMessage () {
            $("#newMessageFile").replaceWith($("#newMessageFile").val('').clone(true));
            $('#newMessagefileIV').attr("src","<?php echo base_url('template/front/assets/img/i-camera.png')?>");

            $('.twemoji-textarea').html("");
            $('.twemoji-textarea-duplicate').html("");
            $('#newMessageText').text("");
            $('#newMessageText').val("");
            $('.close').trigger("click");

        }

        // this function used to clear message div
        function reset () {
            $("#messageFile").replaceWith($("#messageFile").val('').clone(true));
            $('#fileIV').attr("src","<?php echo base_url('template/front/assets/img/i-camera.png')?>");

            $("#messageFile1").replaceWith($("#messageFile1").val('').clone(true));
            $('#fileIV1').attr("src","<?php echo base_url('template/front/assets/img/fileAttach.png')?>");

            $('.twemoji-textarea').html("");
            $('.twemoji-textarea-duplicate').html("");
            $('#message').text("");
            $('#message').val("");

        }


        // function for checking image/video type and size before uploading
        function imageChange(event) {
            let file = this.files[0];
            let imagefile = file.type;
            let size=file.size;
            let match= ["image/jpeg","image/png","image/jpg","video/3gpp","video/mp4","video/3gp","audio/mp3"];
            if(size>20971520){
                toastr.error("Max limit 20Mb exceeded");
                return ;
            }

            if(!((imagefile==match[0]) || (imagefile==match[1]) || (imagefile==match[2]) || (imagefile==match[3]) || (imagefile==match[4]) || (imagefile==match[5])||(imagefile==match[6])))
            {
                toastr.error("This type of file is not allowed");
                return false;
            }else {
                $('#sendMessage').trigger('click');
                /* let type=null;
                 let url=URL.createObjectURL(this.files[0]);
                 if((imagefile==match[0]) || (imagefile==match[1]) || (imagefile==match[2])){
                 type=new Image();
                 type.src=url;
                 type.onload = function() {
                 captureImage(type);
                 };

                 }
                 else{
                 type = document.createElement('video');
                 let source = document.createElement('source');
                 source.setAttribute('src',url);
                 type.appendChild(source);
                 type.muted = true;
                 type.play();
                 setTimeout(function(){
                 type.pause(); // note the [0] to access the native element
                 captureImage(type);
                 }, 3000);

                 }*/

            }
        }

        function attachChange(event) {
            let file = this.files[0];
            let attachFile = file.type;
            let matched=false;
            let size=file.size;
            let match= ["application/pdf","application/msword","application/vnd.ms-excel","application/vnd.ms-powerpoint","text/csv","text/plain","application/zip","application/x-zip-compressed","audio/mp3","audio/x-ms-wma"];
            if(size>20971520){
                toastr.error("Max limit 20Mb exceeded");
                return false ;
            }

            for(let i=0;i<match.length;i++){
                if(attachFile===match[i]){
                    matched=true;
                }
            }
            if(matched){
                $('#sendMessage').trigger('click');
            }else{
                toastr.error("This type of file is not allowed");
                return false;
            }
            /*if(!((imagefile==match[0]) || (imagefile==match[1]) || (imagefile==match[2]) || (imagefile==match[3]) || (imagefile==match[4]) || (imagefile==match[5])||(imagefile==match[6])))
            {
                toastr.error("This type of file is not allowed");
                return false;
            }else {
                $('#sendMessage').trigger('click');


            }*/
        }

        // function for checking image/video type and size before uploading
        function imageChangeNewMessage(event) {
            let file = this.files[0];
            let imagefile = file.type;
            let size=file.size;
            let match= ["image/jpeg","image/png","image/jpg","video/3gpp","video/mp4","video/3gp","audio/mp3"];
            if(size>20971520){
                toastr.error("Max limit 20Mb exceeded");
                return ;
            }

            if(!((imagefile==match[0]) || (imagefile==match[1]) || (imagefile==match[2]) || (imagefile==match[3]) || (imagefile==match[4]) || (imagefile==match[5]) || (imagefile==match[6])))
            {
                toastr.error("This type of file is not allowed");
                return false;
            }else {

                $('#newSendMessage').trigger('click');
                /*let type=null;
                 let url=URL.createObjectURL(this.files[0]);
                 if((imagefile==match[0]) || (imagefile==match[1]) || (imagefile==match[2])){
                 type=new Image();
                 type.src=url;
                 type.onload = function() {
                 captureImagenewMessage(type);
                 };

                 }
                 else{
                 type = document.createElement('video');
                 let source = document.createElement('source');
                 source.setAttribute('src',url);
                 type.appendChild(source);
                 type.muted = true;
                 type.play();
                 setTimeout(function(){
                 type.pause(); // note the [0] to access the native element
                 captureImagenewMessage(type);
                 }, 3000);

                 }*/

            }
        }

        // Api pagination functions
        function increaseStart() {
            start+=limit;
        }
        function resetStart() {
            start=0;
        }
        function resetRetiveMessage(){
            totalRetivedMessage=0;
        }
        function increaseGroupLimit() {
            groupStart+=groupLimit
        }
        function resetFriendStart() {
            friendStart=0;
        }
        function increaseFriendsLimit() {
            friendStart+=friendLimit;
        }
        function addNewGroup(group) {
            let html="";
            groupIds.push(group.groupId);
            time[group.groupId]=group.lastActive;
            html += " <li class=\"person\" data-chat=\"person1\" id='group_"+group.groupId+"' data-group=\""+group.groupId+"\">";
            groupImages[group.groupId]=group.groupImage;
            html +='<span id="groupImage_'+group.groupId+'">';
            for (j=0;j<group.groupImage.length;j++){

                html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+group.groupImage[j]+"\" >";
            }
            html +='</span>';
            html += "                        <span class=\"name\" id='groupName_"+group.groupId+"' style=\"overflow: hidden\"><div>"+group.groupName+"</div><\/span>";
            let date=moment(group.lastActive,moment.ISO_8601).fromNow();

            html += "                        <span id='time_"+group.groupId+"' class=\"time\">"+date+"<\/span>";
            if(group.messageType==="text"){
                let recentMessage=group.recentMessage;
                if(recentMessage===null){
                    recentMessage='';
                }
                html += "                        <span style='float: left;display:none;' id='messageType_"+group.groupId+"' class=\"preview\">"+recentMessage+"<\/span>";
            }else{
                let messageType=group.messageType;
                if(messageType===null){
                    messageType='';
                }
                html += "                        <span style='float: left' id='messageType_"+group.groupId+"' class=\"preview\">"+messageType+"<\/span>";
            }
            if(group.pendingMessage>0){
                html += "                        <div style='' id='notice_"+group.groupId+"' class=\"pad-2 notice text-center\" >New<\/div>";
            }else {
                html += "                        <div style='' id='notice_"+group.groupId+"' class=\"pad-2 notice hidden text-center\" ><\/div>";
            }

            html += "                    <\/li>";

            $("#groups").prepend(html);
        }

        // this function prints group list on the left side
        function printGroupListAppend(groups){
            console.log(groups);
            let html="";
            groupIds=[];

            time={};
            for(let i=0;i<groups.length;i++){
                groupIds.push(groups[i].groupId);
                time[groups[i].groupId]=groups[i].lastActive;
                html += " <li class=\"person\" data-chat=\"person1\" id='group_"+groups[i].groupId+"' data-mecreator="+groups[i].meCreator+" data-group=\""+groups[i].groupId+"\">";
                groupImages[groups[i].groupId]=groups[i].groupImage;
                html +='<span id="groupImage_'+groups[i].groupId+'">';
                for (j=0;j<groups[i].groupImage.length;j++){

                    html += "<img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+groups[i].groupImage[j]+"\" >";
                }
                html +='</span>';
                html += "                        <span class=\"name\" id='groupName_"+groups[i].groupId+"' style=\"overflow: hidden\"><div>"+groups[i].groupName+"</div><\/span>";
                let date=moment(groups[i].lastActive,moment.ISO_8601).fromNow();

                html += "                        <span id='time_"+groups[i].groupId+"' class=\"time\">"+date+"<\/span>";
                if(groups[i].messageType==="text"){
                    let recentMessage=groups[i].recentMessage;
                    if(recentMessage===null){
                        recentMessage='';
                    }
                    html += "                        <span style='float: left;display:none;' id='messageType_"+groups[i].groupId+"' class=\"preview\">"+recentMessage+"<\/span>";
                }else{
                    let messageType=groups[i].messageType;
                    if(messageType===null){
                        messageType='';
                    }
                    html += "                        <span style='float: left' id='messageType_"+groups[i].groupId+"' class=\"preview\">"+messageType+"<\/span>";
                }
                if(groups[i].pendingMessage>0){
                    html += "                        <div style='' id='notice_"+groups[i].groupId+"' class=\"pad-2 notice text-center\" >New<\/div>";
                }else {
                    html += "                        <div style='' id='notice_"+groups[i].groupId+"' class=\"pad-2 notice hidden text-center\" ><\/div>";
                }

                html += "                    <\/li>";
            }
            $("#groups").append(html);
        }
        function printGroupList(groups){
    

            let html="";
            groupIds=[];

            time={};
            for(let i=0;i<groups.length;i++){
                groupIds.push(groups[i].groupId);
                time[groups[i].groupId]=groups[i].lastActive;
                html += " <li class=\"person\" data-chat=\"person1\" id='group_"+groups[i].groupId+"' data-mecreator="+groups[i].meCreator+" data-group=\""+groups[i].groupId+"\">";
                groupImages[groups[i].groupId]=groups[i].groupImage;
                html +='<span id="groupImage_'+groups[i].groupId+'">';
                for (j=0;j<groups[i].groupImage.length;j++){

                    html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+groups[i].groupImage[j]+"\" >";
                }
                html +='</span>';
                html += "                        <span class=\"name\" id='groupName_"+groups[i].groupId+"' style=\"overflow: hidden\"><div>"+groups[i].groupName+"</div><\/span>";
                let date=moment(groups[i].lastActive,moment.ISO_8601).fromNow();

                html += "                        <span id='time_"+groups[i].groupId+"' class=\"time\">"+date+"<\/span>";
                if(groups[i].messageType==="text"){
                    let recentMessage=groups[i].recentMessage;
                    if(recentMessage===null){
                        recentMessage='';
                    }
                    html += "                        <span style='float: left;display:none;' id='messageType_"+groups[i].groupId+"' class=\"preview\">"+recentMessage+"<\/span>";
                }else{
                    let messageType=groups[i].messageType;
                    if(messageType===null){
                        messageType='';
                    }
                    html += "                        <span style='float: left' id='messageType_"+groups[i].groupId+"' class=\"preview\">"+messageType+"<\/span>";
                }
                if(groups[i].pendingMessage>0){
                    html += "                        <div style='' id='notice_"+groups[i].groupId+"' class=\"pad-2 notice text-center\" >New<\/div>";
                }else {
                    html += "                        <div style='' id='notice_"+groups[i].groupId+"' class=\"pad-2 notice hidden text-center\" ><\/div>";
                }

                html += "                    <\/li>";
            }
            $("#groups").html(html);
        }

        //This function is used to get the group list
        function getGroupList(callback) {
			var s_profiler_id=$("#select_profiler_id").val();
            let settings = {
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('imApi/getAllGroups?limit=') ?>"+groupLimit+"&start=0&s_profiler_id="+s_profiler_id,
                "method": "GET",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache"
                },
                "processData": false,
                "contentType": false,
                // "statusCode": {
                //     401: function(error) {
                //         console.log('logout');
                //       location.href="<?php echo base_url('userview/logouts') ?>"
                //     }
                // }
            };

            $.ajax(settings).done(function (response) {

                let groups=response.response;
                totalGroup=response.status.total;
                if(groups.length<=0){
                    $('#addMember').attr('data-group',null);
                    $('#addMember').addClass("hidden");
                    chatBox.html('<img id="blankImg" src="<?php echo base_url('template/front/assets/img/nomess.png')?>" class="img-responsive blankImg" style="width:500px;box-shadow:none !important;">');
                    chatBox.addClass("text-center");
                    $('#groupMembers').html("");
                    $('#groupMembers_').html("");
                    $('#groupMembers_status').html("");
                    $('#groupMembers_name').html("");
                    $('#groupMembers_details').html("");

                    $('#groups').html('');
                    $("#editGroupName").addClass("hidden");
                    $('.UserNames').html('');
					//$('#showHide').hide();
					$('#groupMembers_status').hide();
                }else{
					$('#showHide').show();
					$('#groupMembers_status').show();
                    $('#addMember').removeClass("hidden");
                    $("#editGroupName").removeClass("hidden");

                    printGroupList(groups);
                    // $("#groups li").first().trigger("click");
                    if(callback!=null|| callback!=""){
                        if(groups.length>0){
                            callback(true);
                        }else {
                            callback(false);
                        }

                    }else {
                        $("#groups li").first().trigger("click",[{update:true}]);
                    }
                }



            });

        }

        //this function is used to print the group member list on the right side
        function printGroupMembers(members,meCreator,groupId) {
            console.log(members);
            let html="";
            let html_image="";
            let html_status="";
            let html_name="";
            let html_details="";
            for (i=0;i<members.length;i++){
                html += "<li class=\"person\"  style=\"padding-top: 5px;padding-bottom: 22px;cursor: default;\">";
                if(members[i].active===1){
                    html += "                        <img class='memberStatus memberActive' id='member_"+members[i].userId+"' src=\""+members[i].profilePictureUrl+"\" alt=\"\" \/>";
                }else {
                    html += "<img class='memberStatus' id='member_"+members[i].userId+"' src=\""+members[i].profilePictureUrl+"\" alt=\"\" \/>";
                }
                html += "<span  class=\"name\"><div style='margin-top: 8px'>"+members[i].firstName+" "+members[i].lastName +"</div><\/span>";
                if(meCreator===true || meCreator==="true"){
                    html += "<span class=\"time\" style='padding-top: 5px' ><a href=\"#\" data-group=\""+groupId+"\" data-member=\""+members[i].userId+"\" class=\"btn-danger btn-extra-small btnMemberDelete\"><i class=\"fa fa-trash\"><\/i><\/a><\/span>";
                }
                html += "<\/li>";
            }
            for (i=0;i<members.length;i++){
				let prof = members[i].profession;
				let prof_lan = prof.length;
                // html_image += "<li class=\"person\"  style=\"padding-top: 5px;padding-bottom: 22px;cursor: default;\">";
                if(members[i].active===1){
                    html_status += "<span style='float:left' class='online'> Online </span>";
                }else {
                    html_status += "<span style='float:left;color:#e91e63' class='offline'>Offline</span>";
                }
                html_status += "<input type='hidden' name='statusChange' id='statusChange' value='"+members[i].userId +"'>";
                html_image+="<div class='profile_img'  style='background-image: url("+members[i].profilePictureUrl+")'></div>"
                html_name += "<span  class=\"name\"><div style='margin-top: 8px'>"+members[i].display_name +"</div><\/span>";
                // html_image += "<\/li>";
                html_details+="<span class='stats-label text-uppercase text-left pl-2'>"+members[i].userAge+"</span>";
                
				if(prof_lan > 18){
					html_details+="<span class='stats-label text-uppercase text-left pl-2' style='font-size:9px;padding-top:2px;'>"+members[i].profession+"</span>";
				}else{
					html_details+="<span class='stats-label text-uppercase text-left pl-2'>"+members[i].profession+"</span>";
				}
				if (members[i].profession == '') {
                    html_details+="<p class='stats-label text-uppercase text-left pl-2'></p>";
                }
                html_details+="<span class='stats-label text-uppercase text-left pl-2'>"+members[i].residence+"</span>";
				if (members[i].residence == '') {
                    html_details+="<p class='stats-label text-uppercase text-left pl-2'></p>";
                }
                html_details+="<span class='stats-label text-uppercase text-left pl-2'>"+members[i].my_sect+"</span>";
            }
            $('#groupMembers').html(html);
            $('#groupMembers_').html(html_image);
            $('#groupMembers_status').html(html_status);
            $('#groupMembers_name').html(html_name);
            $('#groupMembers_details').html(html_details);
        }

        //This function is used to get the group member list
        function getGroupMembers(groupId) {
            let settings = {
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('imApi/getMembers?groupId=') ?>"+groupId,
                "method": "GET",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                },
                "processData": false,
                "contentType": false
            };
            $.ajax(settings).done(function (response) {
                let members=response.response.memberList;
                let meCreator=response.response.meCreator;
                printGroupMembers(members,meCreator,groupId);
            });

        }

        //This function is used to print the group name and three member image on the right side top
        function printGroupInfo(groupId,groupImages,groupName){
            let html="";
            let images=groupImages[groupId];
            for(i=0;i<images.length;i++){
                html += "<img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+images[i]+"\" >";
            }
            // $('.rightGroupImages').html(html);
            //$('.be-use-name').html(groupName);
           // $clamp($('.be-use-name')[0], { clamp: 2, useNativeClamp: false });
        }

        function clampData() {
            $('.clamp-desc').each(function (index,element) {
                $clamp(element, {clamp: 4, useNativeClamp: false});
            });
            $('.clamp-title').each(function (index,element) {
                $clamp(element, {clamp: 3, useNativeClamp: false});
            });
        }
        //This function is used to  get friend list of user
        function getMembers(callback) {   // get friends list
            resetFriendStart();
            let settings={
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('user/friendList?start=') ?>"+friendStart+"&limit="+friendLimit,
                "method": "GET",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                },
                "dataType" : 'json'
            };
            $.ajax(settings).done(function (response) {

                let data=response.response.friends;
                totalFriend=response.response.total;
                callback(data);
            });
        }

        //This function is used to clear the current chat box for retrieving new message for the new group
        function clearChatBox() {
            chatBox.html('');
        }

        //This function is used to create the preview for a link sheared in message
        function getLinkPreview(linkData,link){
            let defaultImage="<?php echo base_url('/template/front/assets/img/compact_camera1600.png') ?>";
            if(linkData.playerOrImageUrl.type==='player'){
                return "<div class='i-wrapper'><iframe src='"+linkData.playerOrImageUrl.url+"' class='medea-frame iframe-wrapper' allowfullscreen></iframe></div>";
            }
            else if(linkData.playerOrImageUrl.type==='file'){
                let image = "<img src='" + linkData.playerOrImageUrl.url + "' id='tImg' width='100%' onerror='this.onError=null;this.src="+"\""+String(defaultImage)+"\""+"' >";
                return "<div class='linkPreview-wrapper'>" +
                    "<a href='" + link + "' target=\"_blank\">" +
                    "<div id='texts'>" +
                    "<div id='thumbnail' >" + image +
                    "</div> " +
                    "<div id='desc'>" +
                    "<div id='title'>" +
                    "<div class='clamp-title'>" + linkData.host +
                    "</div>" +
                    "</div>" +
                    "<div class='clamp-desc'>" +
                    "</div> " +
                    "<div id='meta'>" +
                    "<div id='domain'>" + linkData.host +
                    "</div>" +
                    "<div class='clear'></div>" +
                    "</div>" +
                    "</div>" +
                    "</div>" +
                    "</a>" +
                    "</div>";
            }
            else {
                let image = "<img src='<?php echo base_url("/template/front/assets/img/compact_camera1600.png") ?>' id='tImg_blank' width='100%'>";
                if(linkData.playerOrImageUrl.url!=null){
                     image = "<img src='" + linkData.playerOrImageUrl.url + "' id='tImg' width='100%' onerror='this.onError=null;this.src="+"\""+String(defaultImage)+"\""+"' >";
                    return "<div class='linkPreview-wrapper'>" +
                        "<a href='" + link + "' target=\"_blank\">" +
                        "<div id='texts'>" +
                        "<div id='thumbnail' >" + image +
                        "</div> " +
                        "<div id='desc'>" +
                        "<div id='title'>" +
                        "<div class='clamp-title'>" + linkData.title +
                        "</div>" +
                        "</div>" +
                        "<div class='clamp-desc'>" + linkData.description +
                        "</div> " +
                        "<div id='meta'>" +
                        "<div id='domain'>" + linkData.host +
                        "</div>" +
                        "<div class='clear'></div>" +
                        "</div>" +
                        "</div>" +
                        "</div>" +
                        "</a>" +
                        "</div>";
                }
                return "<div class='linkPreview-wrapper'>" +
                    "<a href='" + link + "' target=\"_blank\">" +
                    "<div id='texts'>" +
                    "<div id='thumbnail' >" + image +
                    "</div> " +
                    "<div id='desc'>" +
                    "<div id='title'>" +
                    "<div class='clamp-title'>" + linkData.title +
                    "</div>" +
                    "</div> " +
                    "<div class='clamp-desc'>" + linkData.description +
                    "</div> " +
                    "<div id='meta'>" +
                    "<div id='domain'>" + linkData.host +
                    "</div>" +
                    "<div class='clear'></div>" +
                    "</div>" +
                    "</div>" +
                    "</div>" +
                    "</a>" +
                    "</div>";
            }
        }

        //This function is used to format the links and add the emojis send by user
        function parseMessage(message) {
            return  twemoji.parse(
                anchorme(message,{
                    truncate:[15,10],
                    attributes:[
                        function(urlObj){
                            if(urlObj.protocol !== "mailto:")
                                return {name:"target",value:"blank"};
                        }
                    ]
                })
            );
        }

        //This function is used to retrieve messages from server based on group id
        function getMessage(groupId) {

            if(start==1){
                start=0;
            }
            let url="<?php echo base_url('imApi/getMessage?groupId=') ?>"+groupId+"&limit="+limit+"&start="+start;

            let settings={
                "async": true,
                "crossDomain": true,
                "url": url,
                "method": "GET",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                },
                "processData": false,
                "contentType": false

            };
            $.ajax(settings).done(function (result) {

                //let res = JSON.parse(result);//added
                 let data=result.response;
                //let data=res.response;
                let html="";
                totalRetivedMessage+=data.length;

                if(data.length===0){
                    chatBox.html('<img id="blankImg" src="<?php echo base_url('template/front/assets/img/nomess.png')?>" class="img-responsive blankImg" style="width:500px;margin-top: 20px;">');
                    chatBox.addClass("text-center");
                }else{
                    chatBox.removeClass("text-center");
                    lastMessageDate=moment(data[data.length-1].message.ios_date_time,moment.ISO_8601);
                    let currentDate=lastMessageDate;
                    let flage=true;
                    topMessage=data[0].message.m_id;
                    for(let i=0;i<data.length;i++) {

                        let sender = data[i].sender;
                        let message = data[i].message;

                        let senderId = data[i].sender.userId;
                        let messageDate = moment(data[i].message.date);
                        let seen=data[i].seen;

                        if (currentDate.diff(messageDate, 'days') >= 1 || currentDate.diff(messageDate, 'days') <= -1) {
                            html += "<div class=\"fw-im-message  text-center fw-im-othersender\" data-og-container=\"\">";
                            html += moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions2);
                            html += "                <\/div>";
                            currentDate = messageDate;
                            flage = false;
                        }
                        else if (flage && currentDate.diff(messageDate, 'minutes') >= 30) {
                            html += "<div class=\"fw-im-message  text-center fw-im-othersender\" data-og-container=\"\">";
                            html += moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions2);
                            html += "                <\/div>";
                            currentDate = messageDate;
                        }
                        if (message.type === "update") {
                            html += "<div id='message_" + message.m_id + "' class=\"fw-im-message  text-center fw-im-othersender\" style='font-family: monospace;font-size: large' data-og-container=\"\">";
                            html += "<i  class='oli oli-newspaper'></i> "+ message.message;
                            html += "                <\/div>";
                        }

                        else {
                            if (parseInt(senderId) === parseInt(userId)) {

                                html += "<div class=\"fw-im-message  fw-im-isme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help\" title=\"" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions) + "\">";
                                if (message.type === "text") {

                                    html +=""
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-message-text\"><p style=\"color:#3a3636;\">" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions3) + "</p>" + parseMessage(message.message) + "<\/div>";
                                    if (message.linkData !== null) {
                                        html += getLinkPreview(JSON.parse(message.linkData), message.link);
                                    }
                                }
                                if (message.type === "image") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\"><a style=\"width: 200px;height: 200px\" href=\"" + message.message + "\" class=\"ol-hover hover-5 ol-lightbox\"><img height=\"200px\" width=\"200px\" src=\"" + message.message + "\" alt=\"image hover\">";
                                    html += "                            <div class=\"ol-overlay ov-light-alpha-80\"><\/div>";
                                    html += "                            <div class=\"icons\"><i class=\"fa fa-camera\"><\/i><\/div><\/a>";
                                    html += "                            <\/div>";
                                }
                                if (message.type === "video") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <video id='video_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"video\/mp4\"><\/video>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "audio") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <audio id='audio_" + message.m_id + "' class='video-js  vjs-default-skin' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"audio\/mp3\"><\/audio>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "document") {
                                   // html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <div class=\"fw-im-message-text\"><a id='document_" + message.m_id + "' href="+message.message +" download="+message.fileName+">"+message.fileName+"<\/a></div>";
                                    //html += "                    <\/div>";
                                }
                                html += "                    <div class=\"fw-im-message-author\"  title=\"" + sender.display_name + "\">";
                                html += "                        <img src=\"" + sender.profilePictureUrl + "\" >";
                                html += "                    <\/div>";
                                if(seen===null){
                                    html += "                    <div class=\"fw-im-message-time seen hidden  seenId_"+ message.m_id+"\">";
                                    html += "                        <span class='seenMessage_"+ message.m_id+"'>"+seen+"<\/span>";
                                    html += "                    <\/div>";
                                }
                                else{
                                    html += "                    <div class=\"fw-im-message-time seen  seenId_"+ message.m_id+"\">";
                                    html += "                        <span class='seenMessage_"+ message.m_id+"'>"+seen+"<\/span>";
                                    html += "                    <\/div>";
                                }

                                html += "                <\/div>";
                            }
                            else {
                                html += "                <div class=\"fw-im-message  fw-im-isnotme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help;\" title=\"" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions) + "\">";
                                if (message.type === "text") {
                                    html += "<div style=\"background:lightgray;\"  id='message_" + message.m_id + "' class=\"fw-im-message-text\"><p style=\"color:#000;\">" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions3) + "</p>" + parseMessage(message.message) + "<\/div>";
                                    if (message.linkData !== null) {

                                        html += getLinkPreview(JSON.parse(message.linkData), message.link);
                                    }
                                }
                                if (message.type === "image") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\"><a style=\"width: 200px;height: 200px\" href=\"" + message.message + "\" class=\"ol-hover hover-5 ol-lightbox\"><img height=\"200px\" width=\"200px\" src=\"" + message.message + "\" alt=\"image hover\">";
                                    html += "                            <div class=\"ol-overlay ov-light-alpha-80\"><\/div>";
                                    html += "                            <div class=\"icons\"><i class=\"fa fa-camera\"><\/i><\/div><\/a>";
                                    html += "                            <\/div>";
                                }
                                if (message.type === "video") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\">";
                                    html += "                        <video id='video_" + message.m_id + "' class='video-js' width=\"250px\" height=\"150px\" controls=\"true\" preload='none'  name=\"media\"><source src=\"" + message.message + "\" type=\"video\/mp4\"><\/video>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "audio") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <audio id='audio_" + message.m_id + "' class='video-js  vjs-default-skin' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"audio\/mp3\"><\/audio>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "document") {
                                   // html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <div class=\"fw-im-message-text\"><a  id='document_" + message.m_id + "' href="+message.message +" download="+message.fileName+"  >"+message.fileName+"<\/a></div>";
                                    //html += "                    <\/div>";
                                }
                                html += "                    <div class=\"fw-im-message-author\"  title=\"" + sender.display_name + " \">";
                                if (sender.active === 1) {
                                    html += "                        <img class='auth_" + senderId + " authStatus memberActive'  src=\"" + sender.profilePictureUrl + "\" >";
                                } else {
                                    html += "                        <img class='auth_" + senderId + " authStatus' src=\"" + sender.profilePictureUrl + "\" >";
                                }
                                html += "                    <\/div>";
                                /* html += "                    <div class=\"fw-im-message-time\">";
                                 html += "                        <span style=\"cursor:help\" title=\""+moment(message.ios_date_time,moment.ISO_8601).format('LLLL')+"\">"+moment(message.ios_date_time,moment.ISO_8601).calendar(null,momentOptions)+"<\/span>";
                                 html += "                    <\/div>";*/
                                html += "                <\/div>";
                            }


                        }
                    }

                    chatBox.html("");

                    chatBox.append(html);
                    chatBox.scrollTop(0);

                    for(i=0;i<data.length;i++){
                        let allMessage=data[i].message;
                        if(allMessage.type=="video"){
                            videoObjects.push(videojs("video_"+allMessage.m_id, {}, function(){
                                    // Player (this) is initialized and ready.
                                })
                            );
                        }else if(allMessage.type=="audio"){
                            videoObjects.push(videojs("audio_"+allMessage.m_id, {}, function(){
                                    // Player (this) is initialized and ready.
                                })
                            );
                        }
                    }

                    let height=chatBox[0].scrollHeight;
                    //scrollPosition=height;
                    //chatBox.scrollTop( chatBox.prop( "scrollHeight" ) );
                    chatBox.scrollTop(height);

                    //$('#notice_'+groupId).addClass("hidden");
                    lightBox.init();
                    chatBox.perfectScrollbar({suppressScrollX:true});
                    clampData();


                }


            });

        }
        

        //This function is used to send message to the server
        function sendMessage(form,sendFile,newmessage) {
            let settings=null;
            if(sendFile){
                let progress1 = new LoadingOverlayProgress();

                settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": "<?php echo base_url('imApi/sendMessage') ?>",
                    "method": "POST",
                    "headers": {
                        "authorization": "Basic YWRtaW46MTIzNA==",
                        "Authorizationkeyfortoken": String(responce),
                        "cache-control": "no-cache",
                        "postman-token": "58e7510b-ad46-6037-fc4d-028915069e2b"
                    },
                    "xhr": function() {

                        let xhr = new window.XMLHttpRequest();

                        xhr.upload.addEventListener("progress", function(evt) {
                            if(sendFile) {
                                let percentComplete = evt.loaded / evt.total;
                                percentComplete = parseInt(percentComplete * 100);

                                if (percentComplete >= 100) {
                                    //clearInterval(iid1);
                                    delete progress1;
                                    $("body").LoadingOverlay("hide");
                                    return;
                                }
                                progress1.Update(percentComplete);
                            }
                        }, false);

                        return xhr;
                    },
                    "processData": false,
                    "contentType": false,
                    "mimeType": "multipart/form-data",
                    "data": form,
                    "error":function () {
                        toastr.error("An error occurred. Please try again");
                    },
                    "beforeSend":function () {
                        $('.close').trigger("click");
                        if(sendFile){
                            $("body").LoadingOverlay("show", {
                                custom  : progress1.Init()
                            });
                        }

                    },
                    "complete":function () {
                        delete progress1;
                        $("body").LoadingOverlay("hide");
                    }
                };
            }else{
                typingTimeoutFunction();
                settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": "<?php echo base_url('imApi/sendMessage') ?>",
                    "method": "POST",
                    "headers": {
                        "authorization": "Basic YWRtaW46MTIzNA==",
                        "Authorizationkeyfortoken": String(responce),
                        "cache-control": "no-cache",
                        "postman-token": "58e7510b-ad46-6037-fc4d-028915069e2b"
                    },
                    "processData": false,
                    "contentType": false,
                    "mimeType": "multipart/form-data",
                    "data": form,
                    "error":function () {
                        toastr.error("An error occurred. Please try again");
                    },
                    "beforeSend":function () {
                        $('.close').trigger("click");

                    },
                    "complete":function () {

                    }
                };
            }

            $.ajax(settings).done(function (res) {
                    let json=JSON.parse(res);
                    let group=json.response;

                resetNewMessage();
				getMessage(group.groupId,limit=30,start=0);
                if(newmessage){
                    let currentGroupId=$('#addMember').attr("data-group");
                            $("#group_"+group.groupId).remove();
                            $('.person').removeClass('active');
                            addNewGroup(group);
                            $('#groups li').first().trigger("click",[{update:true}]);

                }

            });
        }

        // unused function. have a plan used in the future
        function captureImage(file) {
            let canvas = document.createElement("canvas");
            canvas.width = 40;
            canvas.height = 40;

            canvas.strokeStyle = 'black';
            canvas.lineWidth = 1;
            canvas.getContext('2d').strokeRect(0, 0, canvas.width, canvas.height);
            canvas.getContext('2d').drawImage(file, 0, 0, canvas.width-1, canvas.height-1);

            let img = document.getElementById("fileIV");
            img.src = canvas.toDataURL("image/png");
            //$output.prepend(img);
        };
        function captureImagenewMessage(file) {
            let canvas = document.createElement("canvas");
            canvas.width = 40;
            canvas.height = 40;

            canvas.strokeStyle = 'black';
            canvas.lineWidth = 1;
            canvas.getContext('2d').strokeRect(0, 0, canvas.width, canvas.height);
            canvas.getContext('2d').drawImage(file, 0, 0, canvas.width-1, canvas.height-1);

            let img = document.getElementById("newMessagefileIV");
            img.src = canvas.toDataURL("image/png");
            //$output.prepend(img);
        };




        //update the message time on the left side
        function updateTime() {
            for (i=0;i<groupIds.length;i++){
                let date=moment(time[groupIds[i]],moment.ISO_8601).fromNow();
                $('#time_'+groupIds[i]).html(date);
            }

        }

// -----------------End of Global functions --------------------------//

        $('#groups').perfectScrollbar({suppressScrollX:true});
        $('#groupMembers').perfectScrollbar({suppressScrollX:true});
        chatBox.perfectScrollbar({suppressScrollX:true});

        $(addmember).on('expand', function(c){
           addexpendDropdown=$('.ms-res-ctn.dropdown-menu').perfectScrollbar({suppressScrollX:true});
            initaddexpendDropdown();
        });

        $(addmember).on('collapse', function(c){
            addexpendDropdown.perfectScrollbar("destroy");
        });

        $(newMemberInput).on('expand', function(c){
            addMemberexpendDropdown=$('.ms-res-ctn.dropdown-menu').perfectScrollbar({suppressScrollX:true});
            initaddMemberexpendDropdown();
        });

        $(newMemberInput).on('collapse', function(c){
            addMemberexpendDropdown.perfectScrollbar("destroy");
        });


        $(newMemberInput).on('keyup', function(e, m, v){
            let value=this.getRawValue().replace(/<script[^>]*>/gi, "&lt;script&gt;").replace(/<\/script[^>]*>/gi, "&lt;/script&gt;").replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/gi," ").replace(/&nbsp;/gi," ").trim();
            let settings = {
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('user/filterFriendList?key=') ?>" + value,
                "method": "GET",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                },
                "dataType": 'json'
            };
            $.ajax(settings).done(function (response) {
                request=true;
                let res = response.response;
                let oldData=[];
                for (let i = 0; i < res.length; i++) {
                    if (res[i].userStatus !== 0) {
                        let md = {
                            id: parseInt(res[i].userId),
                            name: res[i].firstName + " " + res[i].lastName,
                            picture: res[i].profilePictureUrl,
                            email: res[i].userEmail
                        };
                        oldData.push(md);
                        //expendDropdown.append(getMagicData(md));
                    }
                }
                //addmember.setData(oldData);
                newMemberInput.setData(oldData);
            });

        });

        $(addmember).on('keyup', function(e, m, v){
            let value=this.getRawValue().replace(/<script[^>]*>/gi, "&lt;script&gt;").replace(/<\/script[^>]*>/gi, "&lt;/script&gt;").replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/gi," ").replace(/&nbsp;/gi," ").trim();
            let settings = {
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('user/filterFriendList?key=') ?>" + value,
                "method": "GET",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                },
                "dataType": 'json'
            };
            $.ajax(settings).done(function (response) {
                request=true;
                let res = response.response;
                let oldData=[];
                for (let i = 0; i < res.length; i++) {
                    if (res[i].userStatus !== 0) {
                        let md = {
                            id: parseInt(res[i].userId),
                            name: res[i].firstName + " " + res[i].lastName,
                            picture: res[i].profilePictureUrl,
                            email: res[i].userEmail
                        };
                        oldData.push(md);
                        //expendDropdown.append(getMagicData(md));
                    }
                }
                addmember.setData(oldData);
                //newMemberInput.setData(oldData);
            });

        });
        function initaddexpendDropdown() {


            let request = true;
            addexpendDropdown.on("ps-y-reach-end", function () {
                increaseFriendsLimit();
                if (request && friendStart <totalFriend) {
                    request = false;

                    let settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "<?php echo base_url('user/friendList?start=') ?>" + friendStart + "&limit=" + friendLimit,
                        "method": "GET",
                        "headers": {
                            "authorization": "Basic YWRtaW46MTIzNA==",
                            "Authorizationkeyfortoken": String(responce),
                            "cache-control": "no-cache",
                            "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                        },
                        "dataType": 'json'
                    };
                    $.ajax(settings).done(function (response) {
                        request=true;
                        let res = response.response.friends;
                        let oldData=addmember.getData();
                        for (let i = 0; i < res.length; i++) {
                            if (res[i].userStatus !== 0) {
                                let md = {
                                    id: parseInt(res[i].userId),
                                    name: res[i].firstName + " " + res[i].lastName,
                                    picture: res[i].profilePictureUrl,
                                    email: res[i].userEmail
                                };
                                oldData.push(md);
                                //expendDropdown.append(getMagicData(md));
                            }
                        }
                        addmember.setData(oldData);
                        //newMemberInput.setData(oldData);
                    });
                }
            });
        }

        function initaddMemberexpendDropdown()  {


            let request = true;
            addMemberexpendDropdown.on("ps-y-reach-end", function () {
                increaseFriendsLimit();
                if (request && friendStart <totalFriend) {
                    request = false;

                    let settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "<?php echo base_url('user/friendList?start=') ?>" + friendStart + "&limit=" + friendLimit,
                        "method": "GET",
                        "headers": {
                            "authorization": "Basic YWRtaW46MTIzNA==",
                            "Authorizationkeyfortoken": String(responce),
                            "cache-control": "no-cache",
                            "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                        },
                        "dataType": 'json'
                    };
                    $.ajax(settings).done(function (response) {
                        request=true;
                        let res = response.response.friends;
                        let oldData=newMemberInput.getData();
                        for (let i = 0; i < res.length; i++) {
                            if (res[i].userStatus !== 0) {
                                let md = {
                                    id: parseInt(res[i].userId),
                                    name: res[i].firstName + " " + res[i].lastName,
                                    picture: res[i].profilePictureUrl,
                                    email: res[i].userEmail
                                };
                                oldData.push(md);
                                //expendDropdown.append(getMagicData(md));
                            }
                        }
                       // addmember.setData(oldData);
                        newMemberInput.setData(oldData);
                    });
                }
            });
        }

        let requested=true;
        groupBox.on("ps-y-reach-end",function () {
            increaseGroupLimit();
            if(requested && groupStart<totalGroup){
                requested=false;

                let url="<?php echo base_url('imApi/getAllGroups?limit=') ?>"+groupLimit+"&start="+groupStart;
                let settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": url,
                    "method": "GET",
                    "headers": {
                        "authorization": "Basic YWRtaW46MTIzNA==",
                        "Authorizationkeyfortoken": String(responce),
                        "cache-control": "no-cache",
                        "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                    },
                    "processData": false,
                    "contentType": false,
                    "beforeSend":function () {
                        groupBox.append("<div class='text-center groupLoader'><div class='loader'></div></div>");
                    },
                    "complete":function () {
                        $('.groupLoader').remove();

                    }
                };
                $.ajax(settings).done(function (response) {

                    let groups=response.response;
                    printGroupListAppend(groups);
                    requested=true;
                });



            }


        });

        chatBox.on("ps-scroll-up",function() {

            if (notRequested && chatBox.scrollTop()===0) {
                notRequested=false;
                increaseStart();

                let groupId= $('#addMember').attr('data-group');
                let url="<?php echo base_url('imApi/getMessage?groupId=') ?>" + groupId + "&limit="+limit+"&start=" + start;


                let settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": url,
                    "method": "GET",
                    "headers": {
                        "authorization": "Basic YWRtaW46MTIzNA==",
                        "Authorizationkeyfortoken": String(responce),
                        "cache-control": "no-cache",
                        "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                    },
                    "processData": false,
                    "contentType": false,
                    "beforeSend":function () {
                        chatBox.prepend("<div class='loader'></div>");
                    },
                    "complete":function () {
                        $('.loader').remove();

                    }
                };
                $.ajax(settings).done(function (result) {
                    $('.loader').remove();
                    notRequested=true;
                    //let res = JSON.parse(result);//new added
                    let data = result.response;
                    console.log(data);
                    //let data = res.response;
                    if(data.length===0){
                        notRequested=false;
                    }
                    if(totalRetivedMessage===result.totalMessage){
                        resetStart();
                        return;
                    }
                    let html = "";
                    let currentDate=lastMessageDate;
                    let currentTopMessage=topMessage;
                    topMessage=data[0].message.m_id;
                    for (let i = 0; i < data.length; i++) {
                        let self = data[i].self;
                        let sender = data[i].sender;
                        let message = data[i].message;

                        let senderId = data[i].sender.userId;
                        let messageDate = moment(data[i].message.ios_date_time, moment.ISO_8601);


                        if (currentDate.date() - messageDate.date() >= 1 || currentDate.date() - messageDate.date() <= -1) {
                            if (currentDate !== messageDate) {
                                html += "<div class=\"fw-im-message  text-center fw-im-othersender\" data-og-container=\"\">";
                                html += moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions2);
                                html += "                <\/div>";
                                currentDate = messageDate;
                            }
                        }
                        if (message.type === "update") {
                            html += "<div id='message_" + message.m_id + "' class=\"fw-im-message  text-center fw-im-othersender\" style='font-family: monospace;font-size: large' data-og-container=\"\">";
                            html += "<i   class='oli oli-newspaper'></i> "+ message.message;
                            html += "                <\/div>";
                        }

                        else {
                            if (parseInt(senderId) === parseInt(userId)) {
                                html += "<div  class=\"fw-im-message  fw-im-isme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help\" title=\"" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions) + "\">";
                                if (message.type === "text") {
                                    html += "                    <div id='message_" + message.m_id + "' class=\"fw-im-message-text\"><p style=\"color:#f3dada;\">" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions3) + "</p>" + parseMessage(message.message) + "<\/div>";
                                    if (message.linkData != null) {
                                        html += getLinkPreview(JSON.parse(message.linkData), message.link);
                                    }
                                }
                                if (message.type === "image") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\"><a style=\"width: 200px;height: 200px\" href=\"" + message.message + "\" class=\"ol-hover hover-5 ol-lightbox\"><img height=\"200px\" width=\"200px\" src=\"" + message.message + "\" alt=\"image hover\">";
                                    html += "                            <div class=\"ol-overlay ov-light-alpha-80\"><\/div>";
                                    html += "                            <div class=\"icons\"><i class=\"fa fa-camera\"><\/i><\/div><\/a>";
                                    html += "                            <\/div>";
                                }
                                if (message.type === "video") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <video id='video_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none'  name=\"media\"><source src=\"" + message.message + "\" type=\"video\/mp4\"><\/video>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "audio") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <audio id='audio_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"audio\/mp3\"><\/audio>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "document") {
                                    //html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <div class=\"fw-im-message-text\"><a  id='document_" + message.m_id + "' href="+message.message +" download="+message.fileName+" >"+message.fileName+"<\/a></div>";
                                    //html += "                    <\/div>";
                                }
                                html += "                    <div class=\"fw-im-message-author\"   title=\"" + sender.display_name + " \">";
                                html += "                        <img src=\"" + sender.profilePictureUrl + "\" >";
                                html += "                    <\/div>";
                                /*html += "                    <div class=\"fw-im-message-time\">";
                                html += "                        <span style=\"cursor:help\" title=\"" + moment(message.ios_date_time,moment.ISO_8601).format('LLLL') + "\">" + moment(message.ios_date_time,moment.ISO_8601).calendar(null,momentOptions) + "<\/span>";
                                html += "                    <\/div>";*/
                                html += "                <\/div>";
                            }
                            else {
                                html += "                <div class=\"fw-im-message  fw-im-isnotme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help\" title=\"" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions) + "\">";
                                if (message.type === "text") {
                                    html += "                    <div id='message_" + message.m_id + "' class=\"fw-im-message-text\"><p style=\"color:#f3dada;\">" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions3) + "</p>" + parseMessage(message.message) + "<\/div>";
                                    if (message.linkData !== null) {
                                        html += getLinkPreview(JSON.parse(message.linkData), message.link);
                                    }
                                }
                                if (message.type === "image") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\"><a style=\"width: 200px;height: 200px\" href=\"" + message.message + "\" class=\"ol-hover hover-5 ol-lightbox\"><img height=\"200px\" width=\"200px\" src=\"" + message.message + "\" alt=\"image hover\">";
                                    html += "                            <div class=\"ol-overlay ov-light-alpha-80\"><\/div>";
                                    html += "                            <div class=\"icons\"><i class=\"fa fa-camera\"><\/i><\/div><\/a>";
                                    html += "                            <\/div>";
                                }
                                if (message.type === "video") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\">";
                                    html += "                        <video id='video_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\"  preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"video\/mp4\"><\/video>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "audio") {
                                    html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <audio id='audio_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none'  name=\"media\"><source src=\"" + message.message + "\" type=\"audio\/mp3\"><\/audio>";
                                    html += "                    <\/div>";
                                }
                                if (message.type === "document") {
                                    //html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                                    html += "                        <div class=\"fw-im-message-text\"><a  id='document_" + message.m_id + "' href="+message.message +" download="+message.fileName+">"+message.fileName+"<\/a></div>";
                                    //html += "                    <\/div>";
                                }
                                html += "                    <div class=\"fw-im-message-author\"  title=\"" + sender.display_name + " \">";
                                if (sender.active === 1) {
                                    html += "                        <img class='auth_" + senderId + " authStatus memberActive'  src=\"" + sender.profilePictureUrl + "\" >";
                                } else {
                                    html += "                        <img class='auth_" + senderId + " authStatus' src=\"" + sender.profilePictureUrl + "\" >";
                                }
                                html += "                    <\/div>";
                                /* html += "                    <div class=\"fw-im-message-time\">";
                                 html += "                        <span style=\"cursor:help\" title=\"" + moment(message.ios_date_time,moment.ISO_8601).format('LLLL') + "\">" + moment(message.ios_date_time,moment.ISO_8601).calendar(null,momentOptions) + "<\/span>";
                                 html += "                    <\/div>";*/
                                html += "                <\/div>";
                            }
                        }
                    }


                    totalRetivedMessage+=data.length;

                    chatBox.prepend(html);
                    for(i=0;i<data.length;i++){
                        let allMessage=data[i].message;
                        if(allMessage.type=="video"){
                            videoObjects.push(videojs("video_"+allMessage.m_id, {}, function(){
                                    // Player (this) is initialized and ready.
                                })
                            );
                        }else if(allMessage.type=="audio"){
                            videoObjects.push(videojs("audio_"+allMessage.m_id, {}, function(){
                                    // Player (this) is initialized and ready.
                                })
                            );
                        }
                    }
                    /*if(data.length>0){
                     let m_id=data[data.length-1].message.m_id;
                     chatBox.animate({scrollTop:$("#message_"+m_id).offset().top},3);
                     }*/
                    // let height=chatBox[0].scrollHeight;
                    let elmnt = document.getElementById("message_"+currentTopMessage);

                    if(data.length!==0){
                        if(!elmnt){
                            chatBox.scrollTop(scrollPosition);
                        }
                        else{
                            elmnt.scrollIntoView();
                        }

                    }

                    lightBox.init();
                    $('.loader').hide();
                    clampData();

                });
            }
        });
        //$(".rightSection").perfectScrollbar();

        $('#newMessageText').twemojiPicker({
            init: "Type Here.....",
            size: '30px',
            icon: 'grinning',
            iconSize: '25px',
            height: '90px',
            width: '100%',
            border:'0',
            category: ['smile', 'cherry-blossom', 'video-game', 'oncoming-automobile', 'symbols'],
            categorySize: '20px',
            pickerPosition: 'bottom',
            pickerHeight: '150px',
            pickerWidth: '100%'
        });

        let sendMessageSettings= {
            init: "Type Here.....",
            size: '30px',
            icon: 'grinning',
            iconSize: '25px',
            height: '50px',
            width: '100%',
            border:'0',
            category: ['smile', 'cherry-blossom', 'video-game', 'oncoming-automobile', 'symbols'],
            categorySize: '20px',
            pickerPosition: 'top',
            pickerHeight: '150px',
            pickerWidth: '100%'
        };



        if(responce!=null && responce!='' && type==1)
        {

            getGroupList(function (data) {
                if(data){
                    /*let token={
                        _r:String(responce)
                    };
                    socket.emit("messageNotification",JSON.stringify(token));*/
                    $("#groups li").first().trigger("click",[{update:true}]);

                }
            });
        }

        else {
            location.href="<?php echo base_url("home/logout")  ?>";
        }


        $('#message').twemojiPicker(sendMessageSettings);

        $('#groups').on("click",".person",function (e,update) {
            notRequested=true;
            $('#chatBox').perfectScrollbar('destroy');
            for(i=0;i<videoObjects.length;i++){
                videoObjects[i].dispose();
            }
            videoObjects=[];
            resetStart();
            resetRetiveMessage();
            if ($(this).hasClass('active')) {
                return false;
            }
            if ($('#addMember').hasClass('hidden')) {
                $('#addMember').removeClass('hidden');
            }
            let groupId = $(this).attr('data-group');
            let personName = $(this).find('.name').text();
            if(!$("#notice_"+groupId).hasClass("hidden")){
                $("#notice_"+groupId).addClass("hidden");
            }

            $('.UserNames').html(personName);
            $('.person').removeClass('active');
            $(this).addClass('active');
            let oldGroupId=$('#addMember').attr('data-group');
            $('#addMember').attr('data-group',groupId);
            $('#editGroupName').attr('data-group',groupId);
            let updateList=true;
            if(typeof update!=='undefined' ){
                updateList=update.update;
            }
            if(updateList){
                getGroupMembers(groupId);
            }


            clearChatBox();
            getMessage(groupId,start,limit);

            reset();
            let data={groupId:groupId};
            if(oldGroupId!==null|| oldGroupId!==""){
                socket.emit("leaveRoom",oldGroupId);
            }
            printGroupInfo(groupId,groupImages,personName);

            socket.emit("joinRoom",groupId,userId);

        });



        $('#groupMembers').on("click",".btnMemberDelete",function (e) {
            let groupId = $(this).attr('data-group');
            let memberId=$(this).attr('data-member');
            let form=new FormData();

            form.append("groupId",groupId);
            form.append("memberId",memberId);

            let settings = {
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('imApi/deleteMember') ?>",
                "method": "POST",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                },
                "processData": false,
                "contentType": false,
                "data":form
            };

            $.ajax(settings).done(function (res) {
                //let data=JSON.parse(response)

                printGroupMembers(res.response.memberList,res.response.meCreator,groupId);
                groupImages[groupId]=res.response.groupInfo.groupImage;

                let html="";
                for (let j=0;j<res.response.groupInfo.groupImage.length;j++){

                    html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+res.response.groupInfo.groupImage[j]+"\" >";
                }
                $("#groupImage_"+groupId).html(html);
                $("#groupName_"+groupId).html("<div>"+res.response.groupInfo.groupName+"</div>");
                $(".UserNames").html(res.response.groupInfo.groupName);
                printGroupInfo(groupId,groupImages,res.response.groupInfo.groupName);
                toastr.success("Member deleted");
                // getGroupMembers(groupId);

            });

        });



        $('#addMember').on("click",function (e) {

            getMembers(function (res) {
                let q=[];
                for(i=0;i<res.length;i++) {
                    if(res[i].userStatus!=0) {
                        let md = {
                            id: parseInt(res[i].userId),
                            name: res[i].firstName + " " + res[i].lastName,
                            picture: res[i].profilePictureUrl,
                            email: res[i].userEmail
                        };
                        q.push(md);
                    }
                }

                newMemberInput.setData(q);
                newMemberInput.clear();

                $('#addNewMemberModal').modal('show');
            });
        });

        $("#newMemberAddBtn").on("click",function (e) {
            let userIds=newMemberInput.getValue();
            let groupId= $('#addMember').attr('data-group');

            if(userIds.length>0) {
                let form = new FormData();
                for (i = 0; i < userIds.length; i++) {
                    form.append("userId[]", userIds[i]);
                }
                form.append("groupId", groupId);

                let settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": "<?php echo base_url('imApi/addGroupMember/') ?>",
                    "method": "POST",
                    "headers": {
                        "authorization": "Basic YWRtaW46MTIzNA==",
                        "Authorizationkeyfortoken": String(responce),
                        "cache-control": "no-cache",
                        "postman-token": "eb27c011-391a-0b70-37c5-609bcd1d7b6d"
                    },
                    "processData": false,
                    "contentType": false,
                    "data": form
                };
                $.ajax(settings).done(function (res) {

                    printGroupMembers(res.response.memberList, res.response.meCreator, groupId);
                    groupImages[groupId]=res.response.groupInfo.groupImage;

                    let html="";
                    for (let j=0;j<res.response.groupInfo.groupImage.length;j++){

                        html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+res.response.groupInfo.groupImage[j]+"\" >";
                    }
                    $("#groupImage_"+groupId).html(html);
                    $("#groupName_"+groupId).html("<div>"+res.response.groupInfo.groupName+"</div>");
                    $(".UserNames").html(res.response.groupInfo.groupName);
                    printGroupInfo(groupId,groupImages,res.response.groupInfo.groupName);
                    newMemberInput.clear();
                    toastr.success("member add successful");
                    $('#addNewMemberModal').modal('hide');
                    // getGroupMembers(groupId);

                });

            }
        });


        $('#newMessage_').on("click",function (e) {

            resetNewMessage ();
            getMembers(function (res) {
                let q=[];
                for(i=0;i<res.length;i++) {
                    if(res[i].userStatus!=0) {
                        let md = {
                            id: parseInt(res[i].userId),
                            name: res[i].firstName + " " + res[i].lastName,
                            picture: res[i].profilePictureUrl,
                            email: res[i].userEmail
                        };
                        q.push(md);
                    }
                }

                addmember.setData(q);
                addmember.clear();
                addmember.empty();

                $('#newMessageModal').modal('show');
            });
        });

        $('#newMessagefileIV').on("click",function () {
            $("#newMessageFile").click();
        });

        $('#fileIV').on("click",function () {
            $("#messageFile").click();
        });
        $('#fileIV1').on("click",function () {
            $("#messageFile1").click();
        });

        $("#messageFile").change(imageChange);
        $("#messageFile1").change(attachChange);

        $("#newMessageFile").change(imageChangeNewMessage);



        $('#newMessageText_twemoji').on("keyup input",function (e) {
            if (e.which == 13) {
                $('#newSendMessage').trigger('click');
            }
        });

        $('#message_twemoji').on("keyup input",function (e) {

            if (e.which == 13) {
                $('#sendMessage').trigger('click');
            }else{
                onKeyDownNotEnter();
            }
        });

        $('#sendMessage').on("click",function (event) {
            let receiverId=$('#addMember').attr('data-group');
            if(receiverId===null || receiverId===""){
                return;
            }
            $('.close').trigger("click");

            $("#message").find("div:has(br)").each(function(){
                if($(this).html() === '<br>' || $(this).html() === '<br />'){
                    $(this).remove();
                }
            });
            let message=$('#message').text();
            let mainFileObject=null;
            let file=$("#messageFile").val();
            if(file===null || file===""){
                file=$("#messageFile1").val();
                mainFileObject=$("#messageFile1")[0].files[0];
            }
            else{
                mainFileObject=$("#messageFile")[0].files[0]
            }

            let modmessage=message.replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/gi," ").replace(/&nbsp;/gi," ").trim();
            if((modmessage === null || modmessage==="") && (file===null || file==="")){
                reset ();
                return;

            }
            if(modmessage != null || modmessage!=""){

                $('#message').val(modmessage);
            }

            let date=moment().format("YYYY-MM-DD");
            let time=moment().format("HH:mm:ss");

            let form=new FormData($('#messageForm')[0]);
                //debugger;
            form.append("groupId",receiverId);

            form.append("file",mainFileObject);
            reset();
            if(file===null || file===""){

                sendMessage(form,false,false);
            }
            else {
                sendMessage(form,true,false);
            }


        });

        $('.sendMessage').on("click",function (event) {
            let receiverId=$('#addMember').attr('data-group');
            if(receiverId===null || receiverId===""){
                return;
            }
            $('.close').trigger("click");

            $("#message").find("div:has(br)").each(function(){
                if($(this).html() === '<br>' || $(this).html() === '<br />'){
                    $(this).remove();
                }
            });
            let message=$('#message').text();
            let mainFileObject=null;
            let file=$("#messageFile").val();
            if(file===null || file===""){
                file=$("#messageFile1").val();
                mainFileObject=$("#messageFile1")[0].files[0];
            }
            else{
                mainFileObject=$("#messageFile")[0].files[0]
            }

            let modmessage=message.replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/gi," ").replace(/&nbsp;/gi," ").trim();
            if((modmessage === null || modmessage==="") && (file===null || file==="")){
                reset ();
                return;

            }
            if(modmessage != null || modmessage!=""){

                $('#message').val(modmessage);
            }

            let date=moment().format("YYYY-MM-DD");
            let time=moment().format("HH:mm:ss");

            let form=new FormData($('#messageForm')[0]);
                //debugger;
            form.append("groupId",receiverId);

            form.append("file",mainFileObject);
            reset();
            if(file===null || file===""){

                sendMessage(form,false,false);
            }
            else {
                sendMessage(form,true,false);
            }


        });

        $('#newSendMessage').on("click",function (event) {
            //$('.close').trigger("click");

            let message=$('#newMessageText').text();
            let modmessage=message.replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/gi," ").replace(/&nbsp;/gi," ").trim();
            let file=$("#newMessageFile").val();
            if((modmessage == null || modmessage=="") && (file==null || file=="")){
                // resetNewMessage();
                return;

            }
            if(modmessage != null || modmessage!=""){

                $('#newMessageText').val(modmessage);
            }


            //let receiverId=$('#addMember').attr('data-group');
            let date=moment().format("YYYY-MM-DD");
            let time=moment().format("HH:mm:ss");
            let userIds=addmember.getValue();
            if(userIds.length==0){
                return;
            }
            let form=new FormData($('#newMessageForm')[0]);
            for(i=0;i<userIds.length;i++){
                form.append("userId[]",userIds[i]);
            }
            form.append("date",date);
            form.append("time",time);

            sendMessage(form,false,true);
            $('#groups').scrollTop(0);
            //updateGroupList();

        });

        $('#editGroupName').on("click",function (event) {
            $("#groupName").css("border", "1px solid #ccc");
            $("#changeNameModal").modal("show");

        });

        $("#groupName").focus(function () {
            $(this).css("border", "1px solid #ccc");
        });

        $('#changeNameBtn').on("click",function () {
            let groupId=$('#addMember').attr('data-group');
            let groupName=$("#groupName").val();
            groupName=groupName.replace(/<script[^>]*>/gi, "&lt;script&gt;").replace(/<\/script[^>]*>/gi, "&lt;/script&gt;").replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/gi," ").replace(/&nbsp;/gi," ").trim();
            if (groupName==null || groupName==""){
                $('#groupName').css("border","1px solid red");
                toastr.error("Group name is empty");
                return;
            }
            let form=new FormData();
            form.append("groupId",groupId);
            form.append("groupName",groupName);
            let settings = {
                "async": true,
                "crossDomain": true,
                "url": "<?php echo base_url('imApi/changeGroupName') ?>",
                "method": "POST",
                "headers": {
                    "authorization": "Basic YWRtaW46MTIzNA==",
                    "Authorizationkeyfortoken": String(responce),
                    "cache-control": "no-cache",
                    "postman-token": "2a391657-45a9-1a7b-9a67-9b16b0dda13a"
                },
                "processData": false,
                "contentType": false,
                "mimeType": "multipart/form-data",
                "data": form
            };
            $.ajax(settings).done(function (response) {
                toastr.success("Group name update successful");
                $("#changeNameModal").modal("hide");
                //socket.emit('updateData',groupId);
                /*getGroupList(function (data) {
                 if(data){
                 $('#groups li#group_'+groupId).trigger("click",[{update:true}]);
                 }
                 });*/
            })
        });

//------------------  Web sockt section ------------------------------

        socket.on('newMessage',function (res) {

            chatBox.find('#blankImg').hide();
            chatBox.perfectScrollbar({suppressScrollX:true});
            let data=res;
            let sender=data.sender;
            let message=data.message;
            let html="";
            let seen=data.seen;
            let messageDate=moment(message.ios_date_time,moment.ISO_8601);
			
				console.log('lastMessageDate');
			console.log(lastMessageDate);
			console.log('messageDate');
			console.log(messageDate);

			if(lastMessageDate!= null ){
				if( lastMessageDate.date()-messageDate.date()>=1 || lastMessageDate.date()-messageDate.date()<=-1){
                if(lastMessageDate!==messageDate){
                    html += "<div class=\"fw-im-message  text-center fw-im-othersender\" data-og-container=\"\">";
                    html +=moment(message.ios_date_time,moment.ISO_8601).calendar(null,momentOptions2);
                    html += "                <\/div>";
                    lastMessageDate=messageDate;
                }
            }

			}
			else{


                    html += "<div class=\"fw-im-message  text-center fw-im-othersender\" data-og-container=\"\">";
                    html +=moment(message.ios_date_time,moment.ISO_8601).calendar(null,momentOptions2);
                    html += "                <\/div>";
                    lastMessageDate=messageDate;

		
			}
            if(message.type === "update"){
                html += "<div id='message_" + message.m_id + "' class=\"fw-im-message  text-center fw-im-othersender\" style='font-family: monospace;font-size: large' data-og-container=\"\">";
                html +="<i class='oli oli-newspaper'></i> "+ message.message;
                html += "                <\/div>";
            }

           else {
                $(".fw-im-message-time").addClass("hidden");
                if (parseInt(sender.userId) !== parseInt(userId)) {

                    html += "<div  class=\"fw-im-message fw-im-isnotme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help\" title=\"" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions) + "\">";
                    if (message.type === "text") {
                        html += "<div style=\"background:lightgray;\" id='message_" + message.m_id + "' class=\"fw-im-message-text\"><p style=\"color:#000;\">" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions3) + "</p>" + parseMessage(message.message) + "<\/div>";
                        if (message.linkData !== null) {
                            html += getLinkPreview(JSON.parse(message.linkData), message.link);

                        }
                    }
                    if (message.type === "image") {
                        html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\"><a style=\"width: 200px;height: 200px\" href=\"" + message.message + "\" class=\"ol-hover hover-5 ol-lightbox\"><img height=\"200px\" width=\"200px\" src=\"" + message.message + "\" alt=\"image hover\">";
                        html += "                            <div class=\"ol-overlay ov-light-alpha-80\"><\/div>";
                        html += "                            <div class=\"icons\"><i class=\"fa fa-camera\"><\/i><\/div><\/a>";
                        html += "                            <\/div>";
                    }
                    if (message.type === "video") {
                        html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                        html += "                        <video id='video_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"video\/mp4\"><\/video>";
                        html += "                    <\/div>";
                    }
                    if (message.type === "audio") {
                        html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                        html += "                        <audio id='audio_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"audio\/mp3\"><\/audio>";
                        html += "                    <\/div>";
                    }
                    if (message.type === "document") {
                        //html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                        html += "                        <div class=\"fw-im-message-text\"><a  id='document_" + message.m_id + "' href="+message.message +" download="+message.fileName+">"+message.fileName+"<\/a></div>";
                        //html += "                    <\/div>";
                    }
                    html += "<div class=\"fw-im-message-author\"  title=\"" + sender.display_name + " \">";
                    if (sender.active === 1) {
                        html += "<img class='auth_" + sender.userId + " authStatus memberActive'  src=\"" + sender.profilePictureUrl + "\" >";
                    } else {
                        html += "<img class='auth_" + sender.userId + " authStatus' src=\"" + sender.profilePictureUrl + "\" >";
                    }
                    html += "                    <\/div>";

                    html += "                <\/div>";
                    $.playSound("<?php echo base_url('template/front/assets/img/nf')?>");
                    toastr.success("New Message from " + sender.firstName + " " + sender.lastName);
                } else {
                    html += "<div  class=\"fw-im-message  fw-im-isme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help\" title=\"" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions) + "\">";
                    if (message.type === "text") {
                        html += "                    <div  id='message_" + message.m_id + "' class=\"fw-im-message-text\"><p style=\"color:#f3dada;\">" + moment(message.ios_date_time, moment.ISO_8601).calendar(null, momentOptions3) + "</p>" + parseMessage(message.message) + "<\/div>";
                        if (message.linkData !== null) {
                            html += getLinkPreview(JSON.parse(message.linkData), message.link);

                        }
                    }
                    if (message.type === "image") {
                        html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\"><a style=\"width: 200px;height: 200px\" href=\"" + message.message + "\" class=\"ol-hover hover-5 ol-lightbox\"><img height=\"200px\" width=\"200px\" src=\"" + message.message + "\" alt=\"image hover\">";
                        html += "                            <div class=\"ol-overlay ov-light-alpha-80\"><\/div>";
                        html += "                            <div class=\"icons\"><i class=\"fa fa-camera\"><\/i><\/div><\/a>";
                        html += "                            <\/div>";
                    }
                    if (message.type === "video") {
                        html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                        html += "                        <video id='video_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none'  name=\"media\"><source src=\"" + message.message + "\" type=\"video\/mp4\"><\/video>";
                        html += "                    <\/div>";
                    }
                    if (message.type === "audio") {
                        html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                        html += "                        <audio id='audio_" + message.m_id + "' class='video-js ' width=\"250px\" height=\"150px\" controls=\"true\" preload='none' name=\"media\"><source src=\"" + message.message + "\" type=\"audio\/mp3\"><\/audio>";
                        html += "                    <\/div>";
                    }
                    if (message.type === "document") {
                        //html += "<div id='message_" + message.m_id + "' class=\"fw-im-attachments\" >";
                        html += "                        <div class=\"fw-im-message-text\"><a  id='document_" + message.m_id + "' href="+message.message +" download="+message.fileName+">"+message.fileName+"<\/a></div>";
                        //html += "                    <\/div>";
                    }
                    html += "                    <div class=\"fw-im-message-author\"  title=\"" + sender.display_name + " \">";
                    html += "                        <img src=\"" + sender.profilePictureUrl + "\" >";
                    html += "                    <\/div>";
                    if(seen===null){
                        html += "                    <div class=\"fw-im-message-time seen hidden seenId_"+ message.m_id+"\">";
                        html += "                        <span class='seenMessage_"+ message.m_id+"'>no one seen this message yet<\/span>";
                        html += "                    <\/div>";
                    }else {
                        html += "                    <div class=\"fw-im-message-time seen  seenId_"+ message.m_id+"\">";
                        html += "                        <span class='seenMessage_"+ message.m_id+"'>"+seen+"<\/span>";
                        html += "                    <\/div>";
                    }
                    html += "                <\/div>";

                }
            }

            chatBox.append(html);

            if (message.type == "video") {
                videojs("video_" + message.m_id, {}, function () {
                    // Player (this) is initialized and ready.
                });
            }else if(message.type=="audio"){
                videojs("audio_"+message.m_id, {}, function(){
                    // Player (this) is initialized and ready.
                });
            }
            let groupId=data.to;
            if(message.type=="text"){
                $('#messageType_'+groupId).html(message.message);

            }else if(message.type!=="update"){
                $('#messageType_'+groupId).html(message.type);
                lightBox.init();
            }
            $('#time_'+groupId).html(moment(message.ios_date_time,moment.ISO_8601).fromNow());
            time[groupId]=message.ios_date_time;

            let height=chatBox[0].scrollHeight;
            chatBox.scrollTop(height);
            clampData();
        });

        socket.on("userTyping",function (data) {
            var typerGroupId=parseInt(data.groupId);
            var currentGroupId=parseInt($("#addMember").attr("data-group"));


            if(parseInt(data.userId)!==parseInt(userId) && typerGroupId===currentGroupId) {
                let html="";

                html += "<div id='group_"+data.groupId+data.userId+"' class=\"fw-im-message fw-im-isnotme fw-im-othersender\" data-og-container=\"\" style=\"cursor:help\" title=\"" + moment(message.ios_date_time,moment.ISO_8601).calendar(null,momentOptions) + "\">";
                html += "                    <div  class=\"fw-im-message-text\" style='background-color: transparent;white-space: unset;'>";

                html += "<div class=\"typing-indicator\">";
                html += "  <span><\/span>";
                html += "  <span><\/span>";
                html += "  <span><\/span>";
                html += "<\/div>";

                html += "<\/div>";
                html += "                    <div class=\"fw-im-message-author\" title=\"" + data.display_name + "\">";
                html += "                        <img src=\"" + data.profilePicture + "\" title=\"" + data.userName + "\">";
                html += "                    <\/div>";
                html += "                <\/div>";

                chatBox.append(html);
                let height=chatBox[0].scrollHeight;
                chatBox.scrollTop(height);
                $.playSound("<?php echo base_url('template/front/assets/img/typing')?>");
            }

        });
        
        socket.on("receiveSeen",function (data) {
            let m_id=data.forMessage;
            let seenMessage=data.seen;
            $(".seenId_"+m_id).removeClass("hidden");
            $(".seenMessage_"+m_id).html(seenMessage);
            let elmnt = $(".seenMessage_"+m_id)[0];
            if(elmnt){

                elmnt.scrollIntoView();
            }
        });
        
        socket.on("userNotTyping",function (data) {
            var typerGroupId=parseInt(data.groupId);
            var currentGroupId=parseInt($("#addMember").attr("data-group"));
            $("#group_"+data.groupId+data.userId).remove();
            let height=chatBox[0].scrollHeight;
            chatBox.scrollTop(height);

        });

        socket.on("reconnect",function () {
            socket.emit("register",JSON.stringify(tokenData));
            let groupId=$('#addMember').attr("data-group");
            if (groupId!=null || groupId!=""){
                socket.emit("joinRoom",parseInt(groupId),userId);
            }
            $('#connectionErrorModal').modal('hide');
        });

        socket.on("reconnecting",function () {
            $(".memberStatus").removeClass("memberActive");
            $(".authStatus").removeClass("memberActive");

            $('#connectionErrorModal').modal('show');

        });

        socket.on("updateGroupNameData",function (res) {
            let data={
              "groupId":res.groupId,
              "groupName":res.groupName
            };
            let currentGroupId = $('#addMember').attr("data-group");
            if(document.getElementById('group_' + data.groupId) ){
                // group is present and user is currently in this group
                    if(currentGroupId===data.groupId){
                        $("#groupName_"+data.groupId).html("<div>"+data.groupName+"</div>");
                        $('.be-use-name').html(data.groupName);
                        $(".UserNames").html(data.groupName);
                        $clamp($('.be-use-name')[0], { clamp: 2, useNativeClamp: false });
                    }
                // group is present but user currently not chatting on this group
                 else{
                        $("#groupName_"+data.groupId).html("<div>"+data.groupName+"</div>");
                    }
            }

        });

        socket.on("addNewMember",function (res) {
            let data={
              "groupId":res.groupId,
                "group":res.groupInfo,
                "members":res.memberList
            };

            let currentGroupId = $('#addMember').attr("data-group");
            // check group is present but user is not chatting on this group
            if (document.getElementById('group_' + data.groupId) && currentGroupId!==data.groupId){
                let html="";
                for (j=0;j<data.group.groupImage.length;j++){

                    html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+data.group.groupImage[j]+"\" >";
                }
                $("#groupImage_"+data.groupId).html(html);
                $("#groupName_"+data.groupId).html("<div>"+data.group.groupName+"</div>");

            }
            // check group is present and user is currently chatting on this group
            else if(currentGroupId===data.groupId && document.getElementById('group_' + currentGroupId)){
                let html="";
                for (let j=0;j<data.group.groupImage.length;j++){

                    html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+data.group.groupImage[j]+"\" >";
                }
                $("#groupImage_"+data.groupId).html(html);
                $("#groupName_"+data.groupId).html("<div>"+data.group.groupName+"</div>");
                $(".UserNames").html(data.group.groupName);
                let meCreator= $("#group_"+data.groupId).attr("data-mecreator");
                printGroupMembers(data.members,meCreator,data.groupId);
                groupImages[data.groupId]=data.group.groupImage;
                printGroupInfo(data.groupId,groupImages,data.group.groupName);
            }
            // check group is not present
            else{
                addNewGroup(data.group);
            }
        });

        socket.on("deleteAMember",function (res) {
            let data={
                "groupId":res.groupId,
                "group":res.groupInfo,
                "members":res.memberList,
                "removeGroup":res.removeGroup
            };

            let currentGroupId = $('#addMember').attr("data-group");
            // current user is the removed one
            if(data.removeGroup===true && document.getElementById('group_' + data.groupId)){
                // group is present and user is currently on this group
                    if(currentGroupId===data.groupId){
                        $("#group_"+currentGroupId).remove();
                        $("#groups").scrollTop(0);
                        $('#groups li').first().trigger("click",[{update:true}]);
                    }
                // group is present and user is not chatting on this group
                    else{
                        $("#group_"+data.groupId).remove();
                    }
            }
            // group is present and user is currently on this group
            else if(document.getElementById('group_' + data.groupId) && currentGroupId===data.groupId){
                let html="";
                for (let j=0;j<data.group.groupImage.length;j++){

                    html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+data.group.groupImage[j]+"\" >";
                }
                $("#groupImage_"+data.groupId).html(html);
                $("#groupName_"+data.groupId).html("<div>"+data.group.groupName+"</div>");
                $(".UserNames").html(data.group.groupName);
                let meCreator= $("#group_"+data.groupId).attr("data-mecreator");
                printGroupMembers(data.members,meCreator,data.groupId);
                groupImages[data.groupId]=data.group.groupImage;
                printGroupInfo(data.groupId,groupImages,data.group.groupName);
            }
            // group is present and user is not chatting on this group
            else if(document.getElementById('group_' + data.groupId)){
                let html="";
                for (j=0;j<data.group.groupImage.length;j++){

                    html += "                        <img class=\"img-responsive img-circle\" style=\"width: 40px; height: 40px;border-radius: 50%\" src=\""+data.group.groupImage[j]+"\" >";
                }
                $("#groupImage_"+data.groupId).html(html);
                $("#groupName_"+data.groupId).html("<div>"+data.group.groupName+"</div>");
            }

        });

        socket.on("pendingMessage",function (res) {

            let currentGroupId=$('#addMember').attr("data-group");

                    let data=JSON.parse(res);
                    let groupData=data.groupData;
                    let senderId=parseInt(data.senderId);
                        //if sender is not the current user
                        if(senderId!==parseInt(userId)) {


                            // if group present in list then remove the group
                            if (document.getElementById('group_' + groupData.groupId)) {
                                $("#group_" + groupData.groupId).remove();
                            }
                            //if group is not present on grouplist or removed from grouplist then add the group on top
                            addNewGroup(groupData);

                            $('.person').removeClass('active');
                            $('#group_' + currentGroupId).addClass('active');
                            // if(parseInt(data.totalPending)!=0){

                            $.playSound("<?php echo base_url('template/front/assets/img/nf')?>");
                            toastr.success("New message received");
                            //}
                        }
                        // if group is present in the group list on left
                        else if (document.getElementById('group_' + groupData.groupId)) {
                            if(groupData.messageType==="text"){
                                $('#messageType_'+groupData.groupId).html(groupData.recentMessage);
                            }else{
                                $('#messageType_'+groupData.groupId).html(groupData.messageType);
                            }
                            $('#time_'+groupData.groupId).html(moment(groupData.lastActive,moment.ISO_8601).fromNow());
                            time[groupData.groupId]=groupData.lastActive;
                        }

                        // otherwise do nothimg

        });

        socket.on("updateStatus",function (res) {

            let data=JSON.parse(res);
            if(parseInt(data.status)===1){
                if(!$("#member_"+data.userId).hasClass("memberActive")){
                    $("#member_"+data.userId).addClass("memberActive");
                }
                if(!$(".auth_"+data.userId).hasClass("memberActive")){
                    $(".auth_"+data.userId).addClass("memberActive");
                }
            }else{
                if($("#member_"+data.userId).hasClass("memberActive")){
                    $("#member_"+data.userId).removeClass("memberActive");
                }
                if($(".auth_"+data.userId).hasClass("memberActive")){
                    $(".auth_"+data.userId).removeClass("memberActive");
                }
            }

        });

        socket.on("updateStatusOnReconnect",function (res) {
            let data=JSON.parse(res);
            for(let i=0;i<data.friendsIds.length;i++){
                if(!$("#member_"+data.friendsIds[i].userId).hasClass("memberActive")){
                    $("#member_"+data.friendsIds[i].userId).addClass("memberActive");
                }
                if(!$(".auth_"+data.friendsIds[i].userId).hasClass("memberActive")){
                    $(".auth_"+data.friendsIds[i].userId).addClass("memberActive");
                }
            }

        });

//------------------ End of web socket section -------------------------

        setInterval(updateTime, 60000);
    });


</script>